{% extends "base.html" %}
{% load number_filters %}

{% block title %}Orders - IBKR Wheel Strategy{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">üìã Order Management</h1>
            <p class="text-sm text-gray-500 mt-1">Place and manage IBKR orders</p>
        </div>
        <div class="flex items-center space-x-3">
            <span class="px-3 py-1 rounded-full text-sm font-bold {% if connected %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                {% if connected %}üü¢ Gateway Connected{% else %}üî¥ Gateway Disconnected{% endif %}
            </span>
            <a href="{% url 'ibkr:hub' %}" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold text-sm">
                ‚Üê Back to Hub
            </a>
        </div>
    </div>

    {% if not connected %}
    <div class="bg-red-50 border-2 border-red-300 rounded-lg p-5 mb-6">
        <h3 class="text-lg font-bold text-red-900">‚ö†Ô∏è IB Gateway Not Connected</h3>
        <p class="text-sm text-red-800 mt-2">
            You must be connected to IB Gateway to place orders. 
            <a href="{% url 'ibkr:gateway_control' %}" class="underline font-bold">Go to Gateway Control</a> 
            or log in via <a href="http://localhost:6080" target="_blank" class="underline font-bold">noVNC (port 6080)</a>.
        </p>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Place Order Form -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-4 rounded-t-lg">
                <h2 class="text-xl font-bold">üõí Place New Order</h2>
                <p class="text-sm text-blue-100">Submit orders directly to IBKR</p>
            </div>
            
            <div class="p-6 space-y-4">
                <!-- Security Type Toggle -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Security Type</label>
                    <div class="flex space-x-2">
                        <button onclick="setSecType('OPT')" id="btn-OPT" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm">üìä Option</button>
                        <button onclick="setSecType('STK')" id="btn-STK" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold text-sm">üìà Stock</button>
                    </div>
                </div>

                <!-- Action Toggle -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Action</label>
                    <div class="flex space-x-2">
                        <button onclick="setAction('SELL')" id="btn-SELL" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-bold text-sm">SELL (Write)</button>
                        <button onclick="setAction('BUY')" id="btn-BUY" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold text-sm">BUY</button>
                    </div>
                </div>

                <!-- Ticker -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Ticker Symbol</label>
                    <input type="text" id="orderTicker" placeholder="e.g. AAPL" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-bold uppercase" list="tickerList">
                    <datalist id="tickerList">
                        {% for stock in all_stocks %}
                        <option value="{{ stock.ticker }}">{{ stock.ticker }} - {{ stock.name }}</option>
                        {% endfor %}
                    </datalist>
                </div>

                <!-- Option Fields -->
                <div id="optionFields">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Right</label>
                            <select id="orderRight" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-bold">
                                <option value="P">PUT (P)</option>
                                <option value="C">CALL (C)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Strike Price</label>
                            <input type="number" id="orderStrike" step="0.50" placeholder="150.00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-bold">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Expiration Date</label>
                        <input type="date" id="orderExpiry" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Quantity & Order Type -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1" id="qtyLabel">Contracts</label>
                        <input type="number" id="orderQuantity" value="1" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-bold">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Order Type</label>
                        <select id="orderType" onchange="toggleLimitPrice()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-bold">
                            <option value="LMT">Limit (LMT)</option>
                            <option value="MKT">Market (MKT)</option>
                        </select>
                    </div>
                </div>

                <!-- Limit Price -->
                <div id="limitPriceField">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Limit Price (per share)</label>
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-500 font-bold">$</span>
                        <input type="number" id="orderLimitPrice" step="0.01" placeholder="1.50" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-bold text-green-700">
                        <button onclick="getQuote()" class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 font-semibold text-sm" title="Get live quote">üì° Quote</button>
                    </div>
                </div>

                <!-- Quote Display -->
                <div id="quoteDisplay" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="grid grid-cols-4 gap-2 text-sm text-center">
                        <div>
                            <span class="text-gray-500">Bid</span>
                            <div id="quoteBid" class="font-bold text-red-600">-</div>
                        </div>
                        <div>
                            <span class="text-gray-500">Ask</span>
                            <div id="quoteAsk" class="font-bold text-green-600">-</div>
                        </div>
                        <div>
                            <span class="text-gray-500">Mid</span>
                            <div id="quoteMid" class="font-bold text-blue-600">-</div>
                        </div>
                        <div>
                            <span class="text-gray-500">Volume</span>
                            <div id="quoteVolume" class="font-bold text-gray-700">-</div>
                        </div>
                    </div>
                </div>

                <!-- Track Position Checkbox (for SELL options) -->
                <div id="trackPositionField" class="flex items-center space-x-2">
                    <input type="checkbox" id="orderTrackPosition" checked class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <label for="orderTrackPosition" class="text-sm text-gray-700">Also track this position in the database</label>
                </div>

                <!-- Order Summary -->
                <div id="orderSummary" class="bg-gradient-to-r from-gray-50 to-blue-50 border-2 border-blue-300 rounded-lg p-4">
                    <h4 class="text-sm font-bold text-gray-700 mb-2">Order Summary</h4>
                    <div id="orderSummaryText" class="text-sm text-gray-600">
                        Configure your order above...
                    </div>
                </div>

                <!-- Submit Order -->
                <button onclick="submitOrder()" id="submitOrderBtn" class="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed" {% if not connected %}disabled{% endif %}>
                    üöÄ Submit Order
                </button>

                <!-- Order Result -->
                <div id="orderResult" class="hidden rounded-lg p-4 text-sm"></div>
            </div>
        </div>

        <!-- Open Orders -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="bg-gradient-to-r from-green-600 to-teal-600 text-white px-6 py-4 rounded-t-lg flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold">üìã Open Orders</h2>
                    <p class="text-sm text-green-100">Active orders in IBKR</p>
                </div>
                <button onclick="refreshOrders()" class="px-3 py-1 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 text-sm font-semibold">
                    üîÑ Refresh
                </button>
            </div>
            
            <div class="p-4">
                <div id="ordersLoading" class="hidden text-center py-8">
                    <div class="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                    <p class="text-sm text-gray-500">Loading orders...</p>
                </div>
                
                <div id="ordersList">
                    {% if open_orders %}
                    <div class="space-y-3">
                        {% for order in open_orders %}
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="font-bold text-lg {% if order.action == 'SELL' %}text-red-600{% else %}text-green-600{% endif %}">
                                        {{ order.action }}
                                    </span>
                                    <span class="font-bold text-gray-900">{{ order.symbol }}</span>
                                    {% if order.type == 'OPTION' %}
                                    <span class="text-sm text-gray-600">
                                        ${{ order.strike }} {{ order.right }} {{ order.expiry }}
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="text-right">
                                    <span class="px-2 py-1 rounded text-xs font-bold
                                        {% if order.status == 'Filled' %}bg-green-100 text-green-800
                                        {% elif order.status == 'Submitted' %}bg-blue-100 text-blue-800
                                        {% elif order.status == 'PreSubmitted' %}bg-yellow-100 text-yellow-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ order.status }}
                                    </span>
                                </div>
                            </div>
                            <div class="mt-2 flex justify-between items-center text-sm text-gray-600">
                                <span>Qty: {{ order.quantity }} | {{ order.order_type }} {% if order.limit_price %}@ ${{ order.limit_price }}{% endif %}</span>
                                <button onclick="cancelOrder({{ order.order_id }})" class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 font-semibold text-xs">
                                    ‚úï Cancel
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div id="noOrders" class="text-center py-8 text-gray-500">
                        <p class="text-4xl mb-2">üì≠</p>
                        <p class="font-semibold">No open orders</p>
                        <p class="text-sm">Place an order using the form on the left</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Order form state
let orderState = {
    secType: 'OPT',
    action: 'SELL',
};

function setSecType(type) {
    orderState.secType = type;
    document.getElementById('btn-OPT').className = type === 'OPT' 
        ? 'flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm' 
        : 'flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold text-sm';
    document.getElementById('btn-STK').className = type === 'STK' 
        ? 'flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm' 
        : 'flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold text-sm';
    
    document.getElementById('optionFields').style.display = type === 'OPT' ? 'block' : 'none';
    document.getElementById('qtyLabel').textContent = type === 'OPT' ? 'Contracts' : 'Shares';
    document.getElementById('trackPositionField').style.display = (type === 'OPT' && orderState.action === 'SELL') ? 'flex' : 'none';
    updateSummary();
}

function setAction(action) {
    orderState.action = action;
    document.getElementById('btn-SELL').className = action === 'SELL' 
        ? 'flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-bold text-sm' 
        : 'flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold text-sm';
    document.getElementById('btn-BUY').className = action === 'BUY' 
        ? 'flex-1 px-4 py-2 bg-green-600 text-white rounded-lg font-bold text-sm' 
        : 'flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold text-sm';
    
    document.getElementById('trackPositionField').style.display = (orderState.secType === 'OPT' && action === 'SELL') ? 'flex' : 'none';
    updateSummary();
}

function toggleLimitPrice() {
    const type = document.getElementById('orderType').value;
    document.getElementById('limitPriceField').style.display = type === 'LMT' ? 'block' : 'none';
    updateSummary();
}

function updateSummary() {
    const ticker = document.getElementById('orderTicker').value || '???';
    const qty = document.getElementById('orderQuantity').value || 1;
    const orderType = document.getElementById('orderType').value;
    const limitPrice = document.getElementById('orderLimitPrice').value;
    
    let summary = `<strong>${orderState.action}</strong> `;
    
    if (orderState.secType === 'OPT') {
        const right = document.getElementById('orderRight').value;
        const strike = document.getElementById('orderStrike').value || '???';
        const expiry = document.getElementById('orderExpiry').value || '???';
        summary += `${qty}x <strong>${ticker}</strong> $${strike} ${right === 'P' ? 'PUT' : 'CALL'} exp ${expiry}`;
        
        if (orderType === 'LMT' && limitPrice) {
            const totalPremium = parseFloat(limitPrice) * parseInt(qty) * 100;
            summary += ` @ $${limitPrice}/share`;
            if (orderState.action === 'SELL') {
                summary += `<br><span class="text-green-700 font-bold">Premium to collect: $${totalPremium.toFixed(2)}</span>`;
            } else {
                summary += `<br><span class="text-red-700 font-bold">Cost: $${totalPremium.toFixed(2)}</span>`;
            }
        }
    } else {
        summary += `${qty} shares of <strong>${ticker}</strong>`;
        if (orderType === 'LMT' && limitPrice) {
            const totalCost = parseFloat(limitPrice) * parseInt(qty);
            summary += ` @ $${limitPrice}`;
            summary += `<br><span class="font-bold">Total: $${totalCost.toFixed(2)}</span>`;
        }
    }
    
    if (orderType === 'MKT') {
        summary += ' (Market Order)';
    }
    
    document.getElementById('orderSummaryText').innerHTML = summary;
}

// Update summary on input changes
document.addEventListener('DOMContentLoaded', function() {
    ['orderTicker', 'orderRight', 'orderStrike', 'orderExpiry', 'orderQuantity', 'orderType', 'orderLimitPrice'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updateSummary);
        if (el) el.addEventListener('change', updateSummary);
    });
});

async function getQuote() {
    const ticker = document.getElementById('orderTicker').value;
    const expiry = document.getElementById('orderExpiry').value;
    const strike = document.getElementById('orderStrike').value;
    const right = document.getElementById('orderRight').value;
    
    if (!ticker || !expiry || !strike || !right) {
        alert('Fill in ticker, expiry, strike, and right to get a quote');
        return;
    }
    
    try {
        const params = new URLSearchParams({ ticker, expiry, strike, right });
        const res = await fetch(`{% url 'ibkr:option_quote_api' %}?${params}`);
        const data = await res.json();
        
        if (data.success) {
            document.getElementById('quoteDisplay').classList.remove('hidden');
            document.getElementById('quoteBid').textContent = data.bid ? `$${data.bid.toFixed(2)}` : '-';
            document.getElementById('quoteAsk').textContent = data.ask ? `$${data.ask.toFixed(2)}` : '-';
            document.getElementById('quoteMid').textContent = data.mid ? `$${data.mid.toFixed(2)}` : '-';
            document.getElementById('quoteVolume').textContent = data.volume || '-';
            
            // Auto-fill limit price with mid
            if (data.mid) {
                document.getElementById('orderLimitPrice').value = data.mid.toFixed(2);
                updateSummary();
            }
        } else {
            alert('Quote error: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        alert('Failed to get quote: ' + e.message);
    }
}

async function submitOrder() {
    const btn = document.getElementById('submitOrderBtn');
    const resultDiv = document.getElementById('orderResult');
    
    // Build order payload
    const payload = {
        action: orderState.action,
        sec_type: orderState.secType,
        ticker: document.getElementById('orderTicker').value,
        quantity: parseInt(document.getElementById('orderQuantity').value),
        order_type: document.getElementById('orderType').value,
    };
    
    if (payload.order_type === 'LMT') {
        payload.limit_price = parseFloat(document.getElementById('orderLimitPrice').value);
    }
    
    if (orderState.secType === 'OPT') {
        payload.strike = parseFloat(document.getElementById('orderStrike').value);
        payload.expiry = document.getElementById('orderExpiry').value;
        payload.right = document.getElementById('orderRight').value;
        payload.track_position = document.getElementById('orderTrackPosition').checked;
    }
    
    // Validate
    if (!payload.ticker) { alert('Enter a ticker symbol'); return; }
    if (orderState.secType === 'OPT' && (!payload.strike || !payload.expiry || !payload.right)) {
        alert('Fill in strike, expiry, and right for option orders'); return;
    }
    if (payload.order_type === 'LMT' && !payload.limit_price) {
        alert('Enter a limit price for limit orders'); return;
    }
    
    // Confirm
    const confirmMsg = `${payload.action} ${payload.quantity}x ${payload.ticker}` + 
        (orderState.secType === 'OPT' ? ` $${payload.strike} ${payload.right} exp ${payload.expiry}` : '') +
        (payload.limit_price ? ` @ $${payload.limit_price}` : ' at Market');
    
    if (!confirm(`Confirm order:\n\n${confirmMsg}\n\nProceed?`)) return;
    
    btn.disabled = true;
    btn.textContent = '‚è≥ Submitting...';
    
    try {
        const res = await fetch('{% url "ibkr:place_order_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(payload),
        });
        
        const data = await res.json();
        resultDiv.classList.remove('hidden');
        
        if (data.success) {
            resultDiv.className = 'bg-green-50 border-2 border-green-400 rounded-lg p-4 text-sm';
            resultDiv.innerHTML = `
                <p class="font-bold text-green-900">‚úÖ Order Placed Successfully!</p>
                <p class="text-green-800 mt-1">Order #${data.order_id} | Status: ${data.status}</p>
                ${data.position_tracked ? '<p class="text-green-700 mt-1">üìä Position tracked in database</p>' : ''}
            `;
            refreshOrders();
        } else {
            resultDiv.className = 'bg-red-50 border-2 border-red-400 rounded-lg p-4 text-sm';
            resultDiv.innerHTML = `<p class="font-bold text-red-900">‚ùå Order Failed</p><p class="text-red-800 mt-1">${data.error}</p>`;
        }
    } catch (e) {
        resultDiv.classList.remove('hidden');
        resultDiv.className = 'bg-red-50 border-2 border-red-400 rounded-lg p-4 text-sm';
        resultDiv.innerHTML = `<p class="font-bold text-red-900">‚ùå Error</p><p class="text-red-800 mt-1">${e.message}</p>`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'üöÄ Submit Order';
    }
}

async function cancelOrder(orderId) {
    if (!confirm(`Cancel order #${orderId}?`)) return;
    
    try {
        const res = await fetch('{% url "ibkr:cancel_order_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({ order_id: orderId }),
        });
        
        const data = await res.json();
        if (data.success) {
            alert('Order cancelled');
            refreshOrders();
        } else {
            alert('Cancel failed: ' + data.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function refreshOrders() {
    const listDiv = document.getElementById('ordersList');
    const loading = document.getElementById('ordersLoading');
    
    loading.classList.remove('hidden');
    
    try {
        const res = await fetch('{% url "ibkr:open_orders_api" %}');
        const data = await res.json();
        
        loading.classList.add('hidden');
        
        if (data.success && data.orders.length > 0) {
            let html = '<div class="space-y-3">';
            for (const order of data.orders) {
                const actionClass = order.action === 'SELL' ? 'text-red-600' : 'text-green-600';
                const statusClass = order.status === 'Filled' ? 'bg-green-100 text-green-800' 
                    : order.status === 'Submitted' ? 'bg-blue-100 text-blue-800' 
                    : 'bg-yellow-100 text-yellow-800';
                
                html += `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="font-bold text-lg ${actionClass}">${order.action}</span>
                                <span class="font-bold text-gray-900">${order.symbol}</span>
                                ${order.type === 'OPTION' ? `<span class="text-sm text-gray-600">$${order.strike} ${order.right} ${order.expiry}</span>` : ''}
                            </div>
                            <span class="px-2 py-1 rounded text-xs font-bold ${statusClass}">${order.status}</span>
                        </div>
                        <div class="mt-2 flex justify-between items-center text-sm text-gray-600">
                            <span>Qty: ${order.quantity} | ${order.order_type} ${order.limit_price ? '@ $' + order.limit_price : ''}</span>
                            <button onclick="cancelOrder(${order.order_id})" class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 font-semibold text-xs">‚úï Cancel</button>
                        </div>
                    </div>`;
            }
            html += '</div>';
            listDiv.innerHTML = html;
        } else {
            listDiv.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <p class="text-4xl mb-2">üì≠</p>
                    <p class="font-semibold">No open orders</p>
                </div>`;
        }
    } catch (e) {
        loading.classList.add('hidden');
        listDiv.innerHTML = `<p class="text-red-600 text-sm p-4">Error loading orders: ${e.message}</p>`;
    }
}
</script>

{% endblock %}
