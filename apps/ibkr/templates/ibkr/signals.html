{% extends 'base.html' %}
{% load wheel_filters %}

{% block title %}Signals - IBKR Wheel Strategy{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Last Sync & Refresh Bar -->
    <div class="bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-4 mb-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                {% if stocks.0.last_updated %}
                {% with status=stocks.0.last_updated|connection_status %}
                <div class="flex items-center">
                    <span class="mr-2">
                        {% if status == 'live' %}
                        <span class="flex h-3 w-3 relative">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                        </span>
                        {% elif status == 'delayed' %}
                        <span class="inline-flex rounded-full h-3 w-3 bg-yellow-500"></span>
                        {% else %}
                        <span class="inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                        {% endif %}
                    </span>
                    <div class="text-sm text-gray-700">
                        Last synced: <strong>{{ stocks.0.last_updated|date:"m/d/Y H:i" }}</strong>
                        <span class="text-xs text-gray-500">({{ stocks.0.last_updated|time_since_update }})</span>
                    </div>
                </div>
                {% endwith %}
                {% else %}
                <div class="text-sm text-gray-500">No sync data available</div>
                {% endif %}
            </div>
            <div class="flex items-center space-x-2">
                <div id="autoRefreshContainer"></div>
                <a href="{% url 'ibkr:watchlist_refresh' %}" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold text-sm">
                    üîÑ Refresh Data
                </a>
            </div>
        </div>
    </div>

    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">üéØ Wheel Strategy Signals</h1>
            <p class="text-gray-500 mt-1">Cash-Secured Puts & Covered Calls with Multi-Factor Scoring</p>
        </div>
        <a href="{% url 'ibkr:dashboard' %}" class="text-blue-600 hover:text-blue-800">‚Üê Back to Dashboard</a>
    </div>
    
    <!-- Wheel Strategy Explainer -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-4 mb-6">
        <h2 class="text-lg font-bold text-blue-900 mb-2">üìö How the Wheel Strategy Works</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div class="bg-white p-3 rounded border border-blue-200">
                <h3 class="font-semibold text-green-700 mb-2">Phase 1: Cash-Secured Puts</h3>
                <ul class="space-y-1 text-xs text-gray-700">
                    <li>‚úÖ Sell puts at/below support levels</li>
                    <li>‚úÖ Target delta ~0.30 (30% ITM probability)</li>
                    <li>‚úÖ Collect premium while waiting</li>
                    <li>‚úÖ If assigned: Buy stock at discount</li>
                    <li>‚úÖ If expires: Keep premium, repeat</li>
                </ul>
            </div>
            <div class="bg-white p-3 rounded border border-blue-200">
                <h3 class="font-semibold text-purple-700 mb-2">Phase 2: Covered Calls</h3>
                <ul class="space-y-1 text-xs text-gray-700">
                    <li>‚úÖ After assignment, sell calls at/above resistance</li>
                    <li>‚úÖ Target delta ~0.30 (30% ITM probability)</li>
                    <li>‚úÖ Collect premium on owned shares</li>
                    <li>‚úÖ If called away: Profit + premium</li>
                    <li>‚úÖ If expires: Keep premium, repeat</li>
                </ul>
            </div>
        </div>
    </div>
    
    {% if signals %}
    <div class="mb-4 flex items-center justify-between">
        <div class="text-sm text-gray-600">
            Found <strong>{{ signals.count }}</strong> signal(s)
        </div>
        <div class="flex gap-2 text-xs">
            <span class="px-2 py-1 bg-green-100 text-green-800 rounded">A - Excellent (80+)</span>
            <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded">B - Good (60-79)</span>
            <span class="px-2 py-1 bg-red-100 text-red-800 rounded">C - Fair (< 60)</span>
        </div>
    </div>
    
    <div class="space-y-4">
        {% for signal in signals %}
        <div class="bg-white rounded-lg shadow-sm border-2 {% if signal.grade == 'A' %}border-green-200 bg-green-50{% elif signal.grade == 'B' %}border-yellow-200 bg-yellow-50{% else %}border-red-200 bg-red-50{% endif %} p-6 hover:shadow-md transition">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-3">
                        <h3 class="text-2xl font-bold text-blue-600">{{ signal.stock.ticker }}</h3>
                        
                        <!-- Quality Grade Badge (Prominent) -->
                        <span class="px-4 py-2 text-lg font-bold rounded-lg {% if signal.grade == 'A' %}bg-green-500 text-white{% elif signal.grade == 'B' %}bg-yellow-500 text-white{% else %}bg-red-500 text-white{% endif %}">
                            Grade {{ signal.grade|default:"C" }}
                        </span>
                        
                        <!-- Score Display -->
                        <span class="text-sm text-gray-600">
                            Score: <strong>{{ signal.quality_score }}/100</strong>
                        </span>
                        
                        <span class="px-3 py-1 text-xs font-medium rounded-full {% if signal.status == 'OPEN' %}bg-green-100 text-green-800{% elif signal.status == 'FILLED' %}bg-blue-100 text-blue-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ signal.status }}
                        </span>
                        
                        <span class="px-3 py-1 text-xs font-medium rounded-full {% if signal.signal_type == 'COVERED_CALL' %}bg-indigo-100 text-indigo-800{% else %}bg-purple-100 text-purple-800{% endif %}">
                            {{ signal.get_signal_type_display }}
                        </span>
                    </div>
                    
                    <!-- Stock Name -->
                    <p class="text-sm text-gray-700 mb-4">{{ signal.stock.name|default:"" }}</p>
                    
                    <!-- Technical Reason (Prominent) -->
                    {% if signal.technical_reason %}
                    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-blue-900">
                            <strong>üìä Why this signal:</strong> {{ signal.technical_reason }}
                        </p>
                    </div>
                    {% endif %}
                    
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-xs text-gray-500">Strike</p>
                            <p class="text-lg font-semibold">${{ signal.option.strike }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Premium</p>
                            <p class="text-lg font-semibold text-green-600">${{ signal.premium }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">APY</p>
                            <p class="text-lg font-semibold text-blue-600">{{ signal.apy_pct|floatformat:2 }}%</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">ERR</p>
                            <p class="text-lg font-semibold">{{ signal.err_pct|floatformat:2 }}%</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Assignment Risk</p>
                            <p class="text-lg font-semibold {% if signal.assignment_risk > 40 %}text-red-600{% elif signal.assignment_risk > 25 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                {{ signal.assignment_risk|floatformat:1|default:"--" }}%
                            </p>
                        </div>
                    </div>
                    
                    <!-- Score Breakdown -->
                    <div class="grid grid-cols-3 gap-4 mb-4 text-sm">
                        <div class="p-2 bg-white rounded border border-gray-200">
                            <p class="text-xs text-gray-500">Stock Quality (40%)</p>
                            <p class="font-semibold text-green-600">{{ signal.stock_score|floatformat:0 }}/40</p>
                        </div>
                        <div class="p-2 bg-white rounded border border-gray-200">
                            <p class="text-xs text-gray-500">Technical Setup (35%)</p>
                            <p class="font-semibold text-blue-600">{{ signal.technical_score|floatformat:0 }}/35</p>
                        </div>
                        <div class="p-2 bg-white rounded border border-gray-200">
                            <p class="text-xs text-gray-500">Options Metrics (25%)</p>
                            <p class="font-semibold text-purple-600">{{ signal.options_score|floatformat:0 }}/25</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
                        <div>
                            <p class="text-xs text-gray-500">Expiry</p>
                            <p class="font-medium">{{ signal.option.expiry_date|date:"M d, Y" }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">DTE</p>
                            <p class="font-medium">{{ signal.option.dte }} days</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Break Even</p>
                            <p class="font-medium">${{ signal.break_even|floatformat:2 }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Delta</p>
                            <p class="font-medium">{{ signal.option.delta|floatformat:3|default:"--" }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">IV</p>
                            <p class="font-medium">{{ signal.option.implied_volatility|floatformat:2|default:"--" }}%</p>
                        </div>
                    </div>
                    
                    <!-- Stock Fundamentals -->
                    <div class="mt-4 pt-4 border-t border-gray-300">
                        <p class="text-xs text-gray-500 mb-2">Stock Fundamentals</p>
                        <div class="grid grid-cols-4 gap-3 text-xs">
                            <div>
                                <span class="text-gray-600">ROE:</span>
                                <span class="font-medium">{{ signal.stock.roe|floatformat:2|default:"--" }}%</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Beta:</span>
                                <span class="font-medium">{{ signal.stock.beta|floatformat:2|default:"--" }}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Sector:</span>
                                <span class="font-medium">{{ signal.stock.sector|default:"--" }}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Volume:</span>
                                <span class="font-medium">
                                    {% if signal.stock.avg_volume %}
                                        {% if signal.stock.avg_volume >= 1000000 %}
                                            {{ signal.stock.avg_volume|floatformat:0|slice:":-6" }}M
                                        {% else %}
                                            {{ signal.stock.avg_volume|floatformat:0|slice:":-3" }}K
                                        {% endif %}
                                    {% else %}
                                        --
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-right ml-6">
                    <p class="text-xs text-gray-500">Generated</p>
                    <p class="text-sm font-medium">{{ signal.generated_at|date:"M d, Y" }}</p>
                    <p class="text-xs text-gray-500">{{ signal.generated_at|time:"g:i A" }}</p>
                </div>
            </div>
            
            {% if signal.notes %}
            <div class="mt-4 pt-4 border-t border-gray-300">
                <p class="text-sm text-gray-700"><strong>Notes:</strong> {{ signal.notes }}</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center">
        <div class="text-6xl mb-4">‚ö°</div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No Signals Yet</h3>
        <p class="text-gray-500 mb-6">
            Generate signals by following these simple steps:
        </p>
        <div class="space-y-4 max-w-2xl mx-auto text-left">
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm font-semibold text-gray-700 mb-2">Step 1: Calculate Technical Indicators</p>
                <code class="block text-sm text-gray-700 bg-white px-3 py-2 rounded border">python manage.py calculate_indicators</code>
                <p class="text-xs text-gray-500 mt-2">This calculates RSI, EMAs, Support/Resistance for all stocks</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm font-semibold text-gray-700 mb-2">Step 2: Sync IBKR Data & Generate Signals</p>
                <code class="block text-sm text-gray-700 bg-white px-3 py-2 rounded border">python manage.py sync_ibkr --signals</code>
                <p class="text-xs text-gray-500 mt-2">Make sure TWS or IB Gateway is running with API enabled</p>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p class="text-xs text-blue-800">
                    <strong>üí° Tip:</strong> Add more tickers to your watchlist on the Dashboard to get more signal opportunities!
                </p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
const signalsAutoRefresh = new AutoRefresh(() => {
    window.location.reload();
}, {
    interval: 60000, // 1 minute
    enabledByDefault: false,
    storageKey: 'global_autoRefresh'
});

createAutoRefreshToggle(signalsAutoRefresh, 'autoRefreshContainer', {
    label: 'Auto-Refresh',
    icon: 'üîÑ'
});
</script>
{% endblock %}
